# Operaciones OLAP con Amazon Redshift y el dataset Olist

Este documento replica las operaciones OLAP sobre Olist, pero usando
**Amazon Redshift** como motor analítico.

## 0. Contexto y tabla base

Usamos las mismas tablas lógicas que en PostgreSQL:

- `olist_orders`, `olist_order_items`, `olist_products`,
  `olist_customers`, `olist_order_payments`, `olist_order_reviews`.

Tabla base para las consultas (CTE reutilizable):

```sql
WITH fact_olist_sales AS (
    SELECT
        oi.order_id,
        o.customer_id,
        c.customer_city,
        c.customer_state,
        p.product_category_name,
        o.order_status,
        o.order_purchase_timestamp::date AS order_date,
        oi.price,
        oi.freight_value,
        (oi.price + oi.freight_value) AS revenue
    FROM olist_order_items AS oi
    JOIN olist_orders       AS o ON o.order_id = oi.order_id
    JOIN olist_customers    AS c ON c.customer_id = o.customer_id
    JOIN olist_products     AS p ON p.product_id = oi.product_id
)
SELECT *
FROM fact_olist_sales
LIMIT 10;
```

---

## 1. Add measure

```sql
WITH fact_olist_sales AS ( ... )
SELECT
    order_id,
    product_category_name,
    revenue,
    revenue * 0.7                AS estimated_cost,
    revenue - revenue * 0.7      AS estimated_profit
FROM fact_olist_sales;
```

---

## 2. Aggregation operations

```sql
WITH fact_olist_sales AS ( ... )
SELECT
    date_trunc('month', order_date) AS order_month,
    product_category_name,
    SUM(revenue)                    AS total_revenue,
    COUNT(DISTINCT order_id)        AS num_orders
FROM fact_olist_sales
GROUP BY 1, 2
ORDER BY 1, 2;
```

---

## 3. Dice

```sql
WITH fact_olist_sales AS ( ... )
SELECT
    order_id,
    customer_state,
    product_category_name,
    revenue
FROM fact_olist_sales
WHERE
    order_date BETWEEN DATE '2017-01-01' AND DATE '2017-12-31'
    AND customer_state IN ('SP','RJ')
    AND product_category_name = 'bed_bath_table'
    AND revenue > 100;
```

---

## 4. Difference

```sql
WITH fact_olist_sales AS ( ... ),
cube_all AS (
    SELECT
        order_id,
        customer_id,
        order_date,
        revenue
    FROM fact_olist_sales
),
cube_delivered AS (
    SELECT
        order_id,
        customer_id,
        order_date,
        revenue
    FROM fact_olist_sales
    WHERE order_status = 'delivered'
)
SELECT *
FROM cube_all
EXCEPT
SELECT *
FROM cube_delivered;
```

---

## 5. Drill-across

```sql
WITH fact_olist_sales AS ( ... ),
cube_sales AS (
    SELECT
        date_trunc('month', order_date) AS order_month,
        customer_state,
        SUM(revenue)                    AS total_revenue
    FROM fact_olist_sales
    GROUP BY 1, 2
),
cube_reviews AS (
    SELECT
        date_trunc('month', o.order_purchase_timestamp)::date AS order_month,
        c.customer_state,
        AVG(r.review_score)                                   AS avg_review_score
    FROM olist_order_reviews AS r
    JOIN olist_orders        AS o ON o.order_id = r.order_id
    JOIN olist_customers     AS c ON c.customer_id = o.customer_id
    GROUP BY 1, 2
)
SELECT
    s.order_month,
    s.customer_state,
    s.total_revenue,
    r.avg_review_score
FROM cube_sales   AS s
JOIN cube_reviews AS r
  ON s.order_month    = r.order_month
 AND s.customer_state = r.customer_state
ORDER BY 1, 2;
```

---

## 6. Drill-down

```sql
-- Año
WITH fact_olist_sales AS ( ... )
SELECT
    EXTRACT(YEAR FROM order_date) AS year,
    SUM(revenue)                  AS total_revenue
FROM fact_olist_sales
GROUP BY 1
ORDER BY 1;

-- Año y mes
WITH fact_olist_sales AS ( ... )
SELECT
    EXTRACT(YEAR  FROM order_date) AS year,
    EXTRACT(MONTH FROM order_date) AS month,
    SUM(revenue)                   AS total_revenue
FROM fact_olist_sales
GROUP BY 1, 2
ORDER BY 1, 2;
```

---

## 7. Drop measure

```sql
-- Varias medidas
WITH fact_olist_sales AS ( ... )
SELECT
    customer_state,
    date_trunc('month', order_date) AS order_month,
    SUM(price)                      AS sum_price,
    SUM(freight_value)              AS sum_freight,
    SUM(revenue)                    AS total_revenue
FROM fact_olist_sales
GROUP BY 1, 2;

-- Drop measure: solo total_revenue
WITH fact_olist_sales AS ( ... )
SELECT
    customer_state,
    date_trunc('month', order_date) AS order_month,
    SUM(revenue)                    AS total_revenue
FROM fact_olist_sales
GROUP BY 1, 2;
```

---

## 8. Pivot (Rotate) con PIVOT de Redshift

```sql
SELECT *
FROM (
    SELECT
        c.customer_state,
        o.order_status,
        1 AS cnt
    FROM olist_orders   AS o
    JOIN olist_customers AS c ON c.customer_id = o.customer_id
) PIVOT (
    SUM(cnt) FOR order_status IN ('delivered','shipped','canceled')
)
ORDER BY customer_state;
```

---

## 9. Recursive roll-up

```sql
CREATE TABLE dim_product_category (
    category_id          INT PRIMARY KEY,
    parent_category_id   INT NULL REFERENCES dim_product_category(category_id),
    category_name        TEXT
);
```

```sql
WITH RECURSIVE category_tree (category_id, parent_category_id, category_name, level) AS (
    SELECT
        category_id,
        parent_category_id,
        category_name,
        0 AS level
    FROM dim_product_category
    WHERE parent_category_id IS NULL

    UNION ALL

    SELECT
        c.category_id,
        c.parent_category_id,
        c.category_name,
        t.level + 1 AS level
    FROM dim_product_category AS c
    JOIN category_tree       AS t
      ON c.parent_category_id = t.category_id
),
sales_by_leaf AS (
    WITH fact_olist_sales AS ( ... )
    SELECT
        p.category_id,
        SUM(f.revenue) AS leaf_revenue
    FROM fact_olist_sales AS f
    JOIN dim_product_category AS p
      ON f.product_category_name = p.category_name
    GROUP BY p.category_id
)
SELECT
    t.category_name,
    t.level,
    SUM(s.leaf_revenue) AS revenue_rollup
FROM category_tree AS t
LEFT JOIN sales_by_leaf AS s
  ON t.category_id = s.category_id
GROUP BY t.category_name, t.level
ORDER BY t.level, t.category_name;
```

---

## 10. Rename

```sql
-- Alias en la consulta
WITH fact_olist_sales AS ( ... )
SELECT
    product_category_name AS category,
    SUM(revenue)          AS total_sales
FROM fact_olist_sales
GROUP BY product_category_name;

-- Renombrar columna
ALTER TABLE olist_orders
RENAME COLUMN order_purchase_timestamp TO order_ts;
```

---

## 11. Roll-up (GROUP BY ROLLUP)

```sql
WITH fact_olist_sales AS ( ... ),
fact AS (
    SELECT
        customer_state,
        date_trunc('month', order_date) AS order_month,
        revenue
    FROM fact_olist_sales
)
SELECT
    customer_state,
    order_month,
    SUM(revenue) AS total_revenue
FROM fact
GROUP BY ROLLUP (customer_state, order_month)
ORDER BY customer_state, order_month;
```

---

## 12. Roll-up* (secuencia de roll-ups)

```sql
WITH fact_olist_sales AS ( ... )
SELECT
    EXTRACT(YEAR  FROM order_date) AS year,
    EXTRACT(MONTH FROM order_date) AS month,
    EXTRACT(DAY   FROM order_date) AS day,
    SUM(revenue) AS total_revenue
FROM fact_olist_sales
GROUP BY ROLLUP (year, month, day)
ORDER BY year, month, day;
```

---

## 13. Slice

```sql
WITH fact_olist_sales AS ( ... )
SELECT
    product_category_name,
    customer_state,
    SUM(revenue) AS total_revenue
FROM fact_olist_sales
WHERE EXTRACT(YEAR FROM order_date) = 2017
GROUP BY product_category_name, customer_state
ORDER BY product_category_name, customer_state;
```

---

## 14. Sort

```sql
WITH fact_olist_sales AS ( ... )
SELECT
    product_category_name,
    SUM(revenue) AS total_revenue
FROM fact_olist_sales
GROUP BY product_category_name
ORDER BY total_revenue DESC
LIMIT 10;
```

---

## 15. Union

```sql
WITH fact_olist_sales AS ( ... ),
cube_2017 AS (
    SELECT
        2017                          AS year,
        product_category_name,
        SUM(revenue)                  AS total_revenue
    FROM fact_olist_sales
    WHERE EXTRACT(YEAR FROM order_date) = 2017
    GROUP BY product_category_name
),
cube_2018 AS (
    SELECT
        2018                          AS year,
        product_category_name,
        SUM(revenue)                  AS total_revenue
    FROM fact_olist_sales
    WHERE EXTRACT(YEAR FROM order_date) = 2018
    GROUP BY product_category_name
)
SELECT * FROM cube_2017
UNION ALL
SELECT * FROM cube_2018;
```
